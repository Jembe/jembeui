{% macro display_menu_items(menu, level) -%}
    {% for mi in menu.items  %}
        {% if mi.is_menu %}
            {{display_menu(mi, level+1)}}
        {% else %}
            {{display_link(mi, level)}}
        {% endif %}
    {% endfor %}
{%- endmacro %}

{% macro display_menu(menu, level=0) -%}
    {% if menu.is_accessible %}
        {% if level > 0 %}
            <hr class="mdc-list-divider">
            {% if menu.title %}
            <h6 class="mdc-list-group__subheader">
                {{menu.title}}
            </h6>
            {% endif %}
        {% endif %}
        {{display_menu_items(menu, level)}}
    {% endif %}
{%- endmacro %}

{% macro display_link(link, level ) -%}
    {% if link.is_accessible %}
    <a class="mdc-list-item" 
        href="{{link.url}}" 
        {% if link.jrl %}jmb-on:click.prevent="{{link.jrl}}"{% endif %}
        jmb-bind:class="{
            'mdc-list-item--activated': 
            (   
                {{link.active_for_exec_names|tojson|forceescape}}.some(function(en){return $local.componentsOnPage.includes(en)})
                || {{link.active_for_pathnames|tojson|forceescape}}.some(function(pn){return window.location.pathname === pn})
            ) 
        }"
        arai-current="page">
        <span class="mdc-list-item__ripple"></span>
        {% if link.icon %}
        <i class="material-icons mdc-list-item__graphic" aria-hidden="true">{{link.icon}}</i>
        {% endif %}
        <span class="mdc-list-item__text">{{link.title}}</span>
    </a>
    {% endif %}
{%- endmacro %}

<nav jmb-local="{componentsOnPage:[]}"
     jmb-on:jembe-update-page.camel.window="$local.componentsOnPage = $jmb.componentsOnPage();"
     class="mdc-list" role="listbox">
    {{display_menu(menu)}}
</nav>