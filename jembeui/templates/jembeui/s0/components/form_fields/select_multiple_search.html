{% from '/jembeui/s0/macros.html' import display_icon %}
<div 
    jmb-local="{
        focusedOptionId: null,
        selectOption: function($context, $dispatch, optionId) {
            $context.selected.indexOf(optionId) === -1 && $context.selected.push(optionId);
            $dispatch('select-option-changed',{selected:$context.selected});
        },
        focusNext: function ($context) {
            if ($context.$local.focusedOptionId === null) {
                return
            }
            selOption = $context.$el.querySelector('[option-id=\'' + $context.$local.focusedOptionId + '\']')
            nextOption = selOption.nextElementSibling
            if (nextOption === null) {
                nextOption = $context.$el.querySelector('[option-id]');
                if (nextOption === null ) {return}
            }
            $context.$local.focusedOptionId = nextOption.getAttribute('option-id');
            nextOption.scrollIntoViewIfNeeded()
        },
        focusPrev: function ($context) {
            if ($context.$local.focusedOptionId === null) {
                return
            }
            selOption = $context.$el.querySelector('[option-id=\'' + $context.$local.focusedOptionId + '\']')
            prevOption = selOption.previousElementSibling
            if (prevOption === null) {
                prevOption = $context.$el.querySelector('[option-id]:last-of-type');
                if (prevOption === null ) {return}
            }
            $context.$local.focusedOptionId = prevOption.getAttribute('option-id');
            prevOption.scrollIntoViewIfNeeded()
        }
        {#
        ,
        focusNextPage: function ($context) {
            if ($context.$local.focusedOptionId === null) {
                return
            }
            selOption = $context.$el.querySelector('[option-id=\'' + $context.$local.focusedOptionId + '\']');
            movePlaces = 8;
            while (movePlaces > 0 && selOption.nextElementSibling !== null) {
                selOption = selOption.nextElementSibling;
                movePlaces = movePlaces - 1;
            }
            $context.$local.focusedOptionId = selOption.getAttribute('option-id');
            selOption.scrollIntoViewIfNeeded()
        },
        focusPrevPage: function ($context) {
            if ($context.$local.focusedOptionId === null) {
                return
            }
            selOption = $context.$el.querySelector('[option-id=\'' + $context.$local.focusedOptionId + '\']')
            movePlaces = 8;
            while (movePlaces > 0 && selOption.previousElementSibling !== null) {
                selOption = selOption.previousElementSibling;
                movePlaces = movePlaces - 1;
            }
            $context.$local.focusedOptionId = selOption.getAttribute('option-id');
            selOption.scrollIntoViewIfNeeded()
        } #}
    }" 
    jmb-update="function () {
        this.$local.focusedOptionId = {{ "'{}'".format(choices[0][0]) if choices else 'null'}};
    }"
    class="relative">
    {% if selected_choices %}
    <div class="border rounded-t-sm border-grey-300 min-h-[2rem] border-b-0">
    {% for choice in selected_choices  %}
        <div class="px-2 py-1 flex items-center min-h-[2rem] {{loop.cycle('bg-grey-50','bg-white')}}">
            <div class="grow">
                {% if has_view_component %}
                <a jmb-on:click.prevent.stop="{{component('view', id=choice[0]).jrl}}" href="{{component().url}}">
                    {{choice[1]}}
                </a>
                {% elif not has_view_component and has_update_component %}
                    <a jmb-on:click.prevent.stop="{{component('update', id=choice[0]).jrl}}" href="{{component().url}}">
                        {{choice[1]}}
                    </a>
                {% else %}
                    <span class="text-sm">{{choice[1]}}</span>
                {% endif %}
            </div>
            {% if has_update_component and has_view_component and _config.display_update_link %}
                <button jmb-on:click.prevent.stop="{{component('update', id=choice[0]).jrl}}" type="button" class="btn-ghost">
                    {{display_icon("create-outline", class="p-1 text-grey-500")}}
                </button>
            {% endif %}
            {% if not is_disabled %}
            <button jmb-on:click="selected = selected.filter(function(item){ return item !='{{choice[0]}}'});$dispatch('select-option-changed',{selected:selected});" type="button" class="btn-ghost">
                {{display_icon("close-outline", class="p-1 text-grey-500")}}
                {# <img src="{{url_for('jembeui.static', filename='/jembeui/s0/icons/stop-16-grey-90-a80.svg')}}" alt="remove"> #}
            </button>
            {% endif %}
        </div>
    {% endfor %}
    </div>
    {% elif is_disabled %}
    <div class="border rounded-t-sm border-grey-300 min-h-[2rem] "></div>
    {% endif %}

    {% if not is_disabled %}
    <div 
        {% if search is none or choices%}
        jmb-on:focusin.document="if (search !== null && !$self.contains(document.activeElement)){search=null}" 
        jmb-on:click.away="search=null;" 
        {# jmb-on:mouseleave="search=null"  #}
        {%endif%}>
        <div style="display:flex; align-items:center;">
            <input 
            {% if search == "" and not choices %} 
                disabled 
            {% else %}
                value="{{search|default('', true)}}"
                jmb-on:input.debounce="search=$self.value"  
                jmb-on:focus="if (search === null) {search=''}" 
                {# jmb-on:mouseenter="if (search===null) {search=''}"  #}
                {% if search is not none%}jmb-on:ready="$self.focus()"{%endif%}
                jmb-on:keydown.arrow-down.prevent="$local.focusNext($context)" 
                jmb-on:keydown.arrow-up.prevent="$local.focusPrev($context)" 
                {# jmb-on:keydown.page-down.prevent="$local.focusNextPage($context)" 
                jmb-on:keydown.page-up.prevent="$local.focusPrevPage($context)"  #}
                jmb-on:keydown.enter.prevent="$local.focusedOptionId !== null && $local.selectOption($context, $dispatch, $local.focusedOptionId)" 
                jmb-on:keydown.enter.ctrl.prevent="$dispatch('select-option-submit')" 
            {%endif%} 
            placeholder="Select ..."
            type="text" 
            class="form-select grow disabled:border-grey-300 disabled:border-t-0">
            {% if has_create_component %}
            <button type="button" class="button button--ghost"
                jmb-on:click.stop.prevent="{{component('create').jrl}}">
                <img src="{{url_for('jembeui.static', filename='/jembeui/s0/icons/new-16-grey-90-a80.svg')}}" alt="create">
            </button>
            
            {% endif %}
        </div>
        {% if search is not none and choices %}
        <div class="absolute left-0 right-0 z-50 mb-6 overflow-auto bg-white border rounded rounded-t-none shadow border-grey-300 shadow-grey-400 max-h-60">
            <div class="flex flex-col gap-1 py-1">
            {% for choice in  choices %}
            <button type="button" 
                jmb-on:click="$local.selectOption($context, $dispatch, '{{choice[0]}}')" 
                jmb-on:mouseover="$local.focusedOptionId='{{choice[0]}}'"
                jmb-bind:class="{'bg-grey-200': $local.focusedOptionId === '{{choice[0]}}'}"
                class="flex items-center justify-start px-4 btn btn--white "
                tabindex="-1"
                option-id='{{choice[0]}}'>{{choice[1]}}</button>
            {# {%else%}
            <div class="form-field__select-multiple-search__dropdown__item even no-more">
                No more choices
            </div> #}
            {% endfor %}
            </div>
            {% if choices|length != choices_count %}
            <div class="flex items-center justify-center px-4 py-2 text-sm italic bg-white text-grey-600">
                More choices avaiable on search.
            </div>
            {% endif %}
        
        </div>
        {% endif %}
    </div>
    {% endif %}

    {{placeholder("view")}}
    {{placeholder("update")}}
    {{placeholder("create")}}
</div>